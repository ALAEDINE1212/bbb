<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Our Little Universe üíò</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS for the world map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    :root {
      --bg: #fff5fb;
      --card: #ffffff;
      --accent: #ff8fb1;
      --accent-soft: #ffe0ec;
      --text-main: #333;
      --text-soft: #777;
      --radius: 16px;
      --shadow: 0 10px 25px rgba(0,0,0,0.07);
      --transition: 0.25s ease;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #ffe7f3 0, var(--bg) 45%, #ffeef7 100%);
      color: var(--text-main);
      overflow-x: hidden;
    }

    header {
      text-align: center;
      padding: 32px 16px 16px;
    }

    header h1 {
      margin: 0;
      font-size: 2.4rem;
    }

    header p {
      margin: 8px 0 0;
      color: var(--text-soft);
    }

    main {
      max-width: 1100px;
      margin: 0 auto 40px;
      padding: 0 16px 32px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 18px 18px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "‚ô•";
      position: absolute;
      font-size: 80px;
      color: rgba(255,143,177,0.10);
      right: -10px;
      top: -25px;
      transform: rotate(-15deg);
      pointer-events: none;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h2 span.emoji { font-size: 1.2rem; }

    form {
      display: grid;
      gap: 8px;
      margin-bottom: 10px;
    }

    label {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    input[type="text"],
    input[type="date"],
    input[type="url"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #ffd1e3;
      padding: 7px 9px;
      font: inherit;
      outline: none;
      transition: var(--transition);
      background: #fff9fc;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(255,143,177,0.25);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 50px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font: inherit;
      background: var(--accent);
      color: white;
      cursor: pointer;
      align-self: start;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button:hover {
      background: #ff739f;
      transform: translateY(-1px);
      box-shadow: 0 7px 15px rgba(255,115,159,0.35);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .list {
      max-height: 210px;
      overflow: auto;
      margin-top: 6px;
      padding-right: 4px;
    }

    .item {
      border-radius: 10px;
      border: 1px dashed #ffd1e3;
      padding: 6px 8px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      background: #fff9fc;
    }

    .item strong {
      color: #ff4f88;
    }

    .muted {
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    /* Photos */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      margin-top: 8px;
      max-height: 230px;
      overflow: auto;
      padding-right: 4px;
    }

    .photo-card {
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #ffd1e3;
      background: #fff9fc;
      display: flex;
      flex-direction: column;
      font-size: 0.8rem;
    }

    .photo-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    .photo-card div {
      padding: 5px 7px 7px;
    }

    /* Mood calendar */
    .mood-input-row {
      display: grid;
      grid-template-columns: 1.1fr 0.8fr 0.8fr;
      gap: 8px;
      margin-bottom: 4px;
    }

    .mood-calendar {
      margin-top: 8px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #ffd1e3;
      font-size: 0.8rem;
      background: #fff9fc;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: var(--accent-soft);
    }

    .calendar-header button {
      padding: 4px 8px;
      font-size: 0.75rem;
      box-shadow: none;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-top: 1px solid #ffd1e3;
    }

    .calendar-cell {
      border-right: 1px solid #ffe3f0;
      border-bottom: 1px solid #ffe3f0;
      min-height: 40px;
      padding: 3px 4px;
      position: relative;
      background: #ffffff;
    }

    .calendar-cell:nth-child(7n) { border-right: none; }

    .calendar-day-label {
      font-weight: 600;
      text-align: center;
      padding: 4px 0;
      background: #ffeef7;
      border-bottom: 1px solid #ffd1e3;
    }

    .calendar-date {
      font-size: 0.7rem;
      font-weight: 600;
      position: absolute;
      top: 3px;
      right: 4px;
      color: #555;
      text-shadow: 0 0 3px rgba(255,255,255,0.8);
    }

    .calendar-mood {
      position: absolute;
      bottom: 3px;
      left: 4px;
      right: 4px;
      font-size: 0.65rem;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 0 3px rgba(255,255,255,0.9);
    }

    .calendar-cell.empty { background: #fff9fc; }

    /* Map */
    #map {
      width: 100%;
      height: 260px;
      border-radius: 14px;
      overflow: hidden;
      margin-top: 8px;
      border: 1px solid #ffd1e3;
    }

    .map-note {
      margin-top: 4px;
    }

    .inline-buttons {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .inline-buttons button {
      padding: 4px 8px;
      font-size: 0.75rem;
      box-shadow: none;
    }

    .place-photo-thumb {
      margin-top: 4px;
    }

    .place-photo-thumb img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 4px;
    }

    footer {
      text-align: center;
      padding: 8px 16px 16px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }
    footer span { color: #ff4f88; }

    /* Floating hearts animation */
    .floating-heart {
      position: fixed;
      font-size: 20px;
      pointer-events: none;
      animation: floatUp 1.5s ease-out forwards;
      z-index: 999;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-60px) scale(1.4);
        opacity: 0;
      }
    }

    /* Hello darling overlay */
    #helloOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,231,243,0.9), rgba(255,245,251,0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: overlayIn 0.7s ease-out forwards;
    }

    .hello-box {
      background: white;
      padding: 24px 40px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
      font-size: 1.6rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
      animation: helloPop 0.9s ease-out forwards;
    }

    .hello-box small {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    @keyframes helloPop {
      0% { transform: scale(0.7); opacity: 0; }
      50% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes overlayIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .overlay-hide {
      animation: overlayOut 0.6s ease-in forwards;
    }

    @keyframes overlayOut {
      from { opacity: 1; }
      to { opacity: 0; visibility: hidden; }
    }

    @media (max-width: 600px) {
      header h1 { font-size: 2rem; }
      main { padding-bottom: 16px; }
      .hello-box {
        margin: 0 24px;
        font-size: 1.4rem;
        padding: 20px 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Hello darling overlay -->
  <div id="helloOverlay">
    <div class="hello-box">
      <div>Hello darling üíñ</div>
      <small>(tap to enter our little universe)</small>
    </div>
  </div>

  <header>
    <h1>Our Little Universe üíò</h1>
    <p>A tiny place for our memories, moods, and moments together.</p>
  </header>

  <main>
    <!-- Movies -->
    <section class="card">
      <h2><span class="emoji">üé¨</span> Movies We Watched</h2>
      <form id="movieForm">
        <div>
          <label for="movieTitle">Movie title</label>
          <input id="movieTitle" type="text" required placeholder="e.g. Your Name" />
        </div>
        <div>
          <label for="movieDate">Date</label>
          <input id="movieDate" type="date" required />
        </div>
        <div>
          <label for="moviePlace">Where</label>
          <input id="moviePlace" type="text" placeholder="Cinema / sofa / online..." />
        </div>
        <div>
          <label for="movieNote">Little note (optional)</label>
          <textarea id="movieNote" placeholder="What did we love about it?"></textarea>
        </div>
        <button type="submit">Add movie ‚ú®</button>
      </form>
      <div class="list" id="movieList"></div>
    </section>

    <!-- Meetings -->
    <section class="card">
      <h2><span class="emoji">üóìÔ∏è</span> Our Meetings</h2>
      <form id="meetingForm">
        <div>
          <label for="meetingDate">When</label>
          <input id="meetingDate" type="date" required />
        </div>
        <div>
          <label for="meetingWhere">Where</label>
          <input id="meetingWhere" type="text" required placeholder="Place / city / online" />
        </div>
        <div>
          <label for="meetingHow">How was it?</label>
          <textarea id="meetingHow" required placeholder="Cute, chaotic, perfect, rainy..."></textarea>
        </div>
        <button type="submit">Save meeting üíå</button>
      </form>
      <div class="list" id="meetingList"></div>
    </section>

    <!-- Places map -->
    <section class="card">
      <h2><span class="emoji">üìç</span> Places We Visited</h2>
      <form id="placeForm">
        <div>
          <label for="placeName">Place name</label>
          <input id="placeName" type="text" required placeholder="e.g. Paris, Eiffel Tower" />
        </div>
        <div>
          <label for="placeDate">Date</label>
          <input id="placeDate" type="date" required />
        </div>
        <div>
          <label for="placeMapsLink">Google Maps link (optional)</label>
          <input id="placeMapsLink" type="url" placeholder="Paste link from Google Maps for precise coords" />
        </div>
        <div>
          <label>Coordinates (click map or paste link)</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <input id="placeLat" type="text" required placeholder="Latitude" />
            <input id="placeLng" type="text" required placeholder="Longitude" />
          </div>
        </div>
        <div>
          <label for="placeNote">Note (optional)</label>
          <textarea id="placeNote" placeholder="Why was this place special?"></textarea>
        </div>
        <div>
          <label>Photo for this place (optional)</label>
          <select id="placePhotoSelect">
            <option value="">Pick from uploaded photos (optional)</option>
          </select>
          <div style="margin-top:6px;">
            <small class="muted">Or upload a new photo just for this place:</small>
            <input id="placePhotoFile" type="file" accept="image/*" />
          </div>
        </div>
        <button type="submit">Add place üåç</button>
      </form>
      <div id="map"></div>
      <p class="muted map-note">Zoom & move the map. Tap on the map to set coordinates. Pins show places we‚Äôve visited together üíû</p>
      <div class="list" id="placeList"></div>
    </section>

    <!-- Mood calendar -->
    <section class="card">
      <h2><span class="emoji">üé®</span> Mood Colour of the Day</h2>
      <form id="moodForm">
        <div class="mood-input-row">
          <div>
            <label for="moodDate">Day</label>
            <input id="moodDate" type="date" required />
          </div>
          <div>
            <label for="moodColor">Colour</label>
            <input id="moodColor" type="color" value="#ffb6c1" />
          </div>
          <div>
            <label for="moodText">Mood</label>
            <input id="moodText" type="text" placeholder="happy, tired, cozy..." />
          </div>
        </div>
        <button type="submit">Set mood üåà</button>
      </form>

      <div class="mood-calendar">
        <div class="calendar-header">
          <button type="button" id="prevMonth">&lt; Prev</button>
          <div id="calendarTitle"></div>
          <button type="button" id="nextMonth">Next &gt;</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
      <p class="muted">Days are coloured based on your saved mood colour. Click through months to revisit how you've been feeling üíï</p>
    </section>

    <!-- Photos -->
    <section class="card">
      <h2><span class="emoji">üì∏</span> Our Photos</h2>
      <form id="photoForm">
        <div>
          <label for="photoFile">Photo (from your phone)</label>
          <input id="photoFile" type="file" accept="image/*" required />
        </div>
        <div>
          <label for="photoCaption">Caption</label>
          <input id="photoCaption" type="text" placeholder="That day at the park..." />
        </div>
        <button type="submit">Add photo ü•∞</button>
      </form>
      <div class="photo-grid" id="photoGrid"></div>
      <p class="muted">You can upload directly from your phone camera roll.</p>
    </section>
  </main>

  <footer>
    Made with <span>‚ô•</span> just for you.
  </footer>

  <!-- Leaflet JS for the map -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase + App logic -->
  <script type="module">
    // Firebase imports from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
    import {
      getDatabase,
      ref as dbRef,
      push,
      onValue,
      set,
      update,
      remove
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import {
      getStorage,
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBG2JNN8K6x_W_wLlJawc0Gwk08ixwJSHM",
      authDomain: "my-baby-35bb9.firebaseapp.com",
      databaseURL: "https://my-baby-35bb9-default-rtdb.firebaseio.com",
      projectId: "my-baby-35bb9",
      storageBucket: "my-baby-35bb9.firebasestorage.app",
      messagingSenderId: "1022726711006",
      appId: "1:1022726711006:web:22fb3e65b46e7fecdb444f",
      measurementId: "G-42VFML631W"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // ---------- Little helpers ----------
    function spawnHearts() {
      const heart = document.createElement('div');
      heart.className = 'floating-heart';
      heart.textContent = '‚ù§';
      const x = 40 + Math.random() * 20; // center-ish
      const y = 70 + Math.random() * 10;
      heart.style.left = x + 'vw';
      heart.style.top = y + 'vh';
      document.body.appendChild(heart);
      setTimeout(() => heart.remove(), 1600);
    }

    // Hello overlay
    const helloOverlay = document.getElementById('helloOverlay');
    helloOverlay.addEventListener('click', () => {
      helloOverlay.classList.add('overlay-hide');
      setTimeout(() => helloOverlay.remove(), 700);
    });
    // Also auto-hide after a few seconds in case they don't tap
    setTimeout(() => {
      if (document.body.contains(helloOverlay)) {
        helloOverlay.classList.add('overlay-hide');
        setTimeout(() => helloOverlay.remove(), 700);
      }
    }, 4000);

    // ---------- Movies ----------
    const movieForm = document.getElementById('movieForm');
    const movieList = document.getElementById('movieList');
    const moviesRef = dbRef(db, 'movies');

    movieForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('movieTitle').value.trim();
      const date = document.getElementById('movieDate').value;
      const place = document.getElementById('moviePlace').value.trim();
      const note = document.getElementById('movieNote').value.trim();
      if (!title || !date) return;

      await push(moviesRef, { title, date, place, note });
      movieForm.reset();
      setTodayDefaults();
      spawnHearts();
    });

    function renderMovies(snapshot) {
      const data = snapshot.val();
      movieList.innerHTML = '';
      if (!data) {
        movieList.innerHTML = '<p class="muted">No movies yet ‚Äî first movie date soon? üçø</p>';
        return;
      }
      const arr = Object.values(data).sort((a,b) =>
        (a.date || '').localeCompare(b.date || '')
      );
      arr.forEach(m => {
        const div = document.createElement('div');
        div.className = 'item';
        const dateStr = m.date ? new Date(m.date).toLocaleDateString() : 'Unknown date';
        div.innerHTML = `
          <strong>${m.title || 'Untitled'}</strong><br>
          <span class="muted">${dateStr} ¬∑ ${m.place || 'somewhere cozy'}</span>
          ${m.note ? `<div>${m.note}</div>` : ''}
        `;
        movieList.appendChild(div);
      });
    }

    onValue(moviesRef, renderMovies);

    // ---------- Meetings ----------
    const meetingForm = document.getElementById('meetingForm');
    const meetingList = document.getElementById('meetingList');
    const meetingsRef = dbRef(db, 'meetings');

    meetingForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const date = document.getElementById('meetingDate').value;
      const where = document.getElementById('meetingWhere').value.trim();
      const how = document.getElementById('meetingHow').value.trim();
      if (!date || !where || !how) return;

      await push(meetingsRef, { date, where, how });
      meetingForm.reset();
      setTodayDefaults();
      spawnHearts();
    });

    function renderMeetings(snapshot) {
      const data = snapshot.val();
      meetingList.innerHTML = '';
      if (!data) {
        meetingList.innerHTML = '<p class="muted">No meetings saved yet ‚Äî but I\'m already planning the next one üíå</p>';
        return;
      }
      const arr = Object.values(data).sort((a,b) =>
        (a.date || '').localeCompare(b.date || '')
      );
      arr.forEach(meet => {
        const dateStr = meet.date ? new Date(meet.date).toLocaleDateString() : 'Unknown date';
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <strong>${dateStr}</strong> at <strong>${meet.where}</strong><br>
          <div>${meet.how}</div>
        `;
        meetingList.appendChild(div);
      });
    }

    onValue(meetingsRef, renderMeetings);

    // ---------- Places (map + list + photo) ----------
    const placeForm = document.getElementById('placeForm');
    const placeList = document.getElementById('placeList');
    const placesRef = dbRef(db, 'places');
    const placeDateInput = document.getElementById('placeDate');
    const placeLatInput = document.getElementById('placeLat');
    const placeLngInput = document.getElementById('placeLng');
    const placeMapsLinkInput = document.getElementById('placeMapsLink');
    const placePhotoSelect = document.getElementById('placePhotoSelect');
    const placePhotoFileInput = document.getElementById('placePhotoFile');

    let placesData = {};
    let photosData = {};
    let map;
    let markersLayer;
    let selectionMarker = null;

    function initMap() {
      map = L.map('map').setView([20, 0], 2); // World view
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);

      // Click on map to set coords
      map.on('click', (e) => {
        const { lat, lng } = e.latlng;
        placeLatInput.value = lat.toFixed(6);
        placeLngInput.value = lng.toFixed(6);

        if (selectionMarker) {
          markersLayer.removeLayer(selectionMarker);
        }
        selectionMarker = L.marker([lat, lng], { opacity: 0.6 }).addTo(markersLayer);
      });
    }

    initMap();

    function tryParseGoogleMaps(url) {
      if (!url) return;
      let match = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
      if (!match) {
        match = url.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
      }
      if (match) {
        const lat = parseFloat(match[1]);
        const lng = parseFloat(match[2]);
        if (!isNaN(lat) && !isNaN(lng)) {
          placeLatInput.value = lat.toFixed(6);
          placeLngInput.value = lng.toFixed(6);
          map.setView([lat, lng], 13);
          if (selectionMarker) {
            markersLayer.removeLayer(selectionMarker);
          }
          selectionMarker = L.marker([lat, lng], { opacity: 0.6 }).addTo(markersLayer);
        }
      }
    }

    placeMapsLinkInput.addEventListener('change', () => {
      tryParseGoogleMaps(placeMapsLinkInput.value.trim());
    });

    placeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('placeName').value.trim();
      const date = document.getElementById('placeDate').value;
      const latStr = placeLatInput.value.trim();
      const lngStr = placeLngInput.value.trim();
      const note = document.getElementById('placeNote').value.trim();

      const lat = parseFloat(latStr);
      const lng = parseFloat(lngStr);

      if (!name || !date || isNaN(lat) || isNaN(lng)) {
        alert("Please enter a name, date, and valid coordinates.");
        return;
      }

      let photoUrl = '';
      let photoCaption = '';
      const selectedPhotoUrl = placePhotoSelect.value;
      const photoFile = placePhotoFileInput.files[0];

      try {
        if (photoFile) {
          const path = `placePhotos/${Date.now()}_${photoFile.name}`;
          const fileRef = sRef(storage, path);
          await uploadBytes(fileRef, photoFile);
          photoUrl = await getDownloadURL(fileRef);
          photoCaption = `Photo from ${name}`;
        } else if (selectedPhotoUrl) {
          photoUrl = selectedPhotoUrl;
          const opt = placePhotoSelect.options[placePhotoSelect.selectedIndex];
          photoCaption = opt.getAttribute('data-caption') || '';
        }

        await push(placesRef, { name, date, lat, lng, note, photoUrl, photoCaption });
        placeForm.reset();
        setTodayDefaults();
        spawnHearts();
      } catch (err) {
        console.error(err);
        alert('Error saving place. Please try again.');
      }
    });

    function renderPlaces(snapshot) {
      placesData = snapshot.val() || {};
      placeList.innerHTML = '';
      markersLayer.clearLayers();
      selectionMarker = null;

      const keys = Object.keys(placesData);
      if (!keys.length) {
        placeList.innerHTML = '<p class="muted">No places yet ‚Äî our adventures are just starting üåç</p>';
        return;
      }

      const entries = Object.entries(placesData).sort(([,a],[,b]) =>
        (a.date || '').localeCompare(b.date || '')
      );

      const boundsPoints = [];

      entries.forEach(([id, place]) => {
        const lat = parseFloat(place.lat);
        const lng = parseFloat(place.lng);
        const dateStr = place.date ? new Date(place.date).toLocaleDateString() : 'Unknown date';

        // List item
        const div = document.createElement('div');
        div.className = 'item';
        let inner = `
          <strong>${place.name || 'Unnamed place'}</strong><br>
          <span class="muted">${dateStr}</span><br>
          <span class="muted">(${!isNaN(lat) ? lat.toFixed(4) : '?'}, ${!isNaN(lng) ? lng.toFixed(4) : '?'})</span>
        `;
        if (place.note) {
          inner += `<div>${place.note}</div>`;
        }
        if (place.photoUrl) {
          inner += `
            <div class="place-photo-thumb">
              <span class="muted">Photo:</span>
              <img src="${place.photoUrl}" alt="${place.photoCaption || 'Place photo'}">
            </div>
          `;
        }
        inner += `
          <div class="inline-buttons">
            <button type="button" data-id="${id}" data-action="edit">Edit</button>
            <button type="button" data-id="${id}" data-action="delete">Delete</button>
          </div>
        `;
        div.innerHTML = inner;
        placeList.appendChild(div);

        // Map marker
        if (!isNaN(lat) && !isNaN(lng)) {
          const marker = L.marker([lat, lng]);
          let popupText = `<strong>${place.name || 'Place'}</strong><br>${dateStr}`;
          if (place.note) popupText += `<br>${place.note}`;
          if (place.photoUrl) {
            popupText += `<br><img src="${place.photoUrl}" style="max-width:150px;border-radius:8px;margin-top:4px;">`;
          }
          marker.bindPopup(popupText);
          marker.addTo(markersLayer);
          boundsPoints.push([lat, lng]);
        }
      });

      if (boundsPoints.length) {
        map.fitBounds(boundsPoints, { padding: [30, 30] });
      }
    }

    onValue(placesRef, renderPlaces);

    // Edit / Delete actions for places
    placeList.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      const place = placesData[id];
      if (!place) return;

      if (action === 'delete') {
        if (confirm('Delete this place?')) {
          await remove(dbRef(db, 'places/' + id));
        }
      } else if (action === 'edit') {
        const newName = prompt('Place name:', place.name || '');
        if (newName === null) return; // cancelled
        const newDate = prompt('Date (YYYY-MM-DD):', place.date || '');
        if (newDate === null) return;
        const newLatStr = prompt('Latitude:', String(place.lat ?? ''));
        if (newLatStr === null) return;
        const newLngStr = prompt('Longitude:', String(place.lng ?? ''));
        if (newLngStr === null) return;
        const newNote = prompt('Note:', place.note || '');
        if (newNote === null) return;

        const newLat = parseFloat(newLatStr);
        const newLng = parseFloat(newLngStr);
        if (!newName || !newDate || isNaN(newLat) || isNaN(newLng)) {
          alert('Invalid values, changes not saved.');
          return;
        }

        await update(dbRef(db, 'places/' + id), {
          name: newName,
          date: newDate,
          lat: newLat,
          lng: newLng,
          note: newNote
        });
        spawnHearts();
      }
    });

    // ---------- Photos (Firebase Storage upload) ----------
    const photoForm = document.getElementById('photoForm');
    const photoGrid = document.getElementById('photoGrid');
    const photosRef = dbRef(db, 'photos');
    const photoFileInput = document.getElementById('photoFile');

    photoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = photoFileInput.files[0];
      const caption = document.getElementById('photoCaption').value.trim();

      if (!file) {
        alert('Please choose a photo first.');
        return;
      }

      try {
        const path = `photos/${Date.now()}_${file.name}`;
        const fileRef = sRef(storage, path);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);

        await push(photosRef, {
          url,
          caption,
          path
        });

        photoForm.reset();
        spawnHearts();
      } catch (err) {
        console.error(err);
        alert('Error uploading photo. Please try again.');
      }
    });

    function renderPhotos(snapshot) {
      const data = snapshot.val();
      photosData = data || {};
      photoGrid.innerHTML = '';
      placePhotoSelect.innerHTML = '<option value="">Pick from uploaded photos (optional)</option>';

      if (!data) {
        photoGrid.innerHTML = '<p class="muted">Add our first photo memory here üì∑</p>';
        return;
      }

      const entries = Object.entries(data);
      entries.forEach(([id, p]) => {
        // Gallery
        const card = document.createElement('div');
        card.className = 'photo-card';
        const img = document.createElement('img');
        img.src = p.url;
        img.alt = p.caption || 'Our photo';
        img.loading = 'lazy';
        const cap = document.createElement('div');
        cap.textContent = p.caption || '';
        card.appendChild(img);
        card.appendChild(cap);
        photoGrid.appendChild(card);

        // Option for places select
        const opt = document.createElement('option');
        opt.value = p.url;
        opt.textContent = p.caption || 'Photo';
        opt.setAttribute('data-caption', p.caption || '');
        placePhotoSelect.appendChild(opt);
      });
    }

    onValue(photosRef, renderPhotos);

    // ---------- Mood + Calendar ----------
    const moodForm = document.getElementById('moodForm');
    const moodDateInput = document.getElementById('moodDate');
    const moodColorInput = document.getElementById('moodColor');
    const moodTextInput = document.getElementById('moodText');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarTitle = document.getElementById('calendarTitle');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const moodsRef = dbRef(db, 'moods');

    let moods = {}; // { 'YYYY-MM-DD': { color, text } }
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth(); // 0-11

    function dateKey(y, m, d) {
      return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    function buildCalendar(year, month) {
      calendarGrid.innerHTML = '';
      const monthName = new Date(year, month, 1).toLocaleString(undefined, { month: 'long', year: 'numeric' });
      calendarTitle.textContent = monthName;

      const dayLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      dayLabels.forEach(label => {
        const cell = document.createElement('div');
        cell.className = 'calendar-day-label';
        cell.textContent = label;
        calendarGrid.appendChild(cell);
      });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      for (let i=0; i<firstDay; i++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell empty';
        calendarGrid.appendChild(cell);
      }

      for (let d=1; d<=daysInMonth; d++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        const key = dateKey(year, month, d);
        const mood = moods[key];

        const dateSpan = document.createElement('span');
        dateSpan.className = 'calendar-date';
        dateSpan.textContent = d;
        cell.appendChild(dateSpan);

        if (mood) {
          cell.style.background = mood.color || '#fde7f1';
          const moodSpan = document.createElement('div');
          moodSpan.className = 'calendar-mood';
          moodSpan.textContent = mood.text || '';
          cell.appendChild(moodSpan);
        }

        calendarGrid.appendChild(cell);
      }
    }

    moodForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const date = moodDateInput.value;
      const color = moodColorInput.value || '#ffb6c1';
      const text = moodTextInput.value.trim();
      if (!date) return;

      await set(dbRef(db, 'moods/' + date), { color, text });
      moodTextInput.value = '';
      spawnHearts();
    });

    onValue(moodsRef, (snapshot) => {
      moods = snapshot.val() || {};
      buildCalendar(currentYear, currentMonth);
    });

    prevMonthBtn.addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      buildCalendar(currentYear, currentMonth);
    });

    nextMonthBtn.addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      buildCalendar(currentYear, currentMonth);
    });

    // ---------- Init ----------
    function setTodayDefaults() {
      const t = new Date();
      const iso = t.toISOString().slice(0,10);
      const movieDate = document.getElementById('movieDate');
      const meetingDate = document.getElementById('meetingDate');
      if (movieDate && !movieDate.value) movieDate.value = iso;
      if (meetingDate && !meetingDate.value) meetingDate.value = iso;
      if (moodDateInput && !moodDateInput.value) moodDateInput.value = iso;
      if (placeDateInput && !placeDateInput.value) placeDateInput.value = iso;
    }

    setTodayDefaults();
    buildCalendar(currentYear, currentMonth);
  </script>
</body>
</html>
